/***********************************Jieli tech************************************************
  File : usb_midi.c
  By   : mawancheng
  date : 2025-3-31
  brief: 该文件为usb_midi功能依赖的驱动，核心函数为midi_tx_data函数，文件末尾有相关的demo_code
********************************************************************************************/

/* #include "os/os_api.h" */
#include "usb/device/usb_stack.h"
#include "usb_config.h"
#include "clock.h"

#include "app_config.h"

#define LOG_TAG_CONST       USB
#define LOG_TAG             "[USB]"
#include "log.h"

#if (TCFG_PC_ENABLE && (USB_DEVICE_CLASS_CONFIG & MIDI_CLASS))
#define     MIDI_EP_IN  2
#define     MIDI_EP_MAXP_SIZE   0x40

static const u8 sMidiDescriptor[] = {
    0x09,        // bLength
    0x04,        // bDescriptorType (Interface)
    0x00,        // bInterfaceNumber 0
    0x00,        // bAlternateSetting
    0x00,        // bNumEndpoints 0
    0x01,        // bInterfaceClass (Audio)
    0x01,        // bInterfaceSubClass (Audio Control)
    0x00,        // bInterfaceProtocol
    0x00,        // iInterface (String Index)

    0x09,        // bLength
    0x24,        // bDescriptorType (See Next Line)
    0x01,        // bDescriptorSubtype (CS_INTERFACE -> HEADER)
    0x00, 0x01,  // bcdADC 1.00
    0x09, 0x00,  // wTotalLength 9
    0x01,        // binCollection 0x01
    0x01,        // baInterfaceNr 1

    0x09,        // bLength
    0x04,        // bDescriptorType (Interface)
    0x01,        // bInterfaceNumber 1
    0x00,        // bAlternateSetting
    0x02,        // bNumEndpoints 2
    0x01,        // bInterfaceClass (Audio)
    0x03,        // bInterfaceSubClass
    0x00,        // bInterfaceProtocol
    0x00,        // iInterface (String Index)

    0x07,        // bLength
    0x24,        // bDescriptorType (See Next Line)
    0x01, 0x00, 0x01, 0x25, 0x00,
    0x06,        // bLength
    0x24,        // bDescriptorType (See Next Line)
    0x02, 0x01, 0x01, 0x00,
    0x06,        // bLength
    0x24,        // bDescriptorType (See Next Line)
    0x02, 0x02, 0x02, 0x00,
    0x09,        // bLength
    0x24,        // bDescriptorType (See Next Line)
    0x03, 0x01, 0x03, 0x01, 0x02, 0x01, 0x00,
    0x09,        // bLength
    0x24,        // bDescriptorType (See Next Line)
    0x03, 0x02, 0x04, 0x01, 0x01, 0x01, 0x00,

    0x07,        // bLength
    0x05,        // bDescriptorType (See Next Line)
    USB_DIR_IN | MIDI_EP_IN,        // bEndpointAddress (IN/D2H)
    USB_ENDPOINT_XFER_BULK,        // bmAttributes (Bulk)
    MIDI_EP_MAXP_SIZE, 0x00,  // wMaxPacketSize 64
    0x00,        // bInterval 0 (unit depends on device speed)

    0x05,        // bLength
    0x25,        // bDescriptorType (See Next Line)
    0x01, 0x01, 0x03,
    0x07,        // bLength
    0x05,        // bDescriptorType (See Next Line)
    0x02,        // bEndpointAddress (OUT/H2D)
    0x02,        // bmAttributes (Bulk)
    0x40, 0x00,  // wMaxPacketSize 64
    0x00,        // bInterval 0 (unit depends on device speed)

    0x05,        // bLength
    0x25,        // bDescriptorType (See Next Line)
    0x01, 0x01, 0x01,
    /* 88 bytes */
};

static void midi_endpoint_init(struct usb_device_t *usb_device, u32 itf)
{
    const usb_dev usb_id = usb_device2id(usb_device);
    u8 *ep_buffer = usb_get_ep_buffer(usb_id, MIDI_EP_IN | USB_DIR_IN);
    usb_g_ep_config(usb_id, MIDI_EP_IN | USB_DIR_IN, USB_ENDPOINT_XFER_BULK, 0, ep_buffer, MIDI_EP_MAXP_SIZE);

    usb_enable_ep(usb_id, HID_EP_IN);
    log_info("midi tx dma buffer 0x%x", (void *)ep_buffer);
}

static void midi_reset(struct usb_device_t *usb_device, u32 itf)
{
    /* const usb_dev usb_id = usb_device2id(usb_device); */
    log_debug("%s", __func__);
    midi_endpoint_init(usb_device, itf);
}

/*----------------------------------------------------------------------------*/
/**@brief   向usb发送midi事件的核心函数，
   @brief   可在PC识别到USB之后调用该函数向PC端发送midi事件
   @param   struct usb_device_t *usb_device
   @param   const u8 *buffer  midi事件buf指针
   @param   u32 len  需要发送的midi事件长度
   @return  本次发送的midi事件长度
   @author  mawancheng
   @note    static u32 midi_tx_data(struct usb_device_t *usb_device, const u8 *buffer, u32 len)
*/
/*----------------------------------------------------------------------------*/
static u32 midi_tx_data(struct usb_device_t *usb_device, const u8 *buffer, u32 len)
{
    const usb_dev usb_id = usb_device2id(usb_device);
    put_buf((u8 *)buffer, len);
    return usb_g_intr_write(usb_id, MIDI_EP_IN, buffer, len);
}

static u32 midi_itf_hander(struct usb_device_t *usb_device, struct usb_ctrlrequest *req)
{
    const usb_dev usb_id = usb_device2id(usb_device);
    /* u32 tx_len; */
    u8 *tx_payload = usb_get_setup_buffer(usb_device);
    u32 bRequestType = req->bRequestType & USB_TYPE_MASK;
    switch (bRequestType) {
    case USB_TYPE_STANDARD:
        break;
    }
    return 0;
}

u32 midi_desc_config(const usb_dev usb_id, u8 *ptr, u32 *cur_itf_num)
{
    log_debug("midi interface num:%d\n", *cur_itf_num);
    /* u8 *_ptr = ptr; */
    memcpy(ptr, sMidiDescriptor, sizeof(sMidiDescriptor));
    ptr[2] = *cur_itf_num;
    if (usb_set_interface_hander(usb_id, *cur_itf_num, midi_itf_hander) != *cur_itf_num) {
        ASSERT(0, "midi set interface_hander fail");
    }
    if (usb_set_reset_hander(usb_id, *cur_itf_num, midi_reset) != *cur_itf_num) {
        ASSERT(0, "midi set interface_reset_hander fail");
    }

    *cur_itf_num = *cur_itf_num + 2;
    return sizeof(sMidiDescriptor) ;
}

//********************************************demo_code_start****************************************//
//
#define BT1 32,24


static const u8  SongTable[] = {
    373 / 256, 373 % 256,

    //引子
    1, 83, 70, BT1 / 2, //7
    2, 83, 0, 84, 90, BT1 / 2, //1
    2, 84, 0, 86, 90, BT1 / 2, //2
    2, 86, 0, 91, 90, BT1 / 2, //5
    2, 91, 0, 89, 90, BT1 / 2, //4
    2, 89, 0, 81, 90, BT1 / 2, //6
    2, 81, 0, 79, 90, BT1 / 2, //5
    2, 79, 0, 88, 90, BT1 / 2, //3

    2, 88, 0, 86, 90, BT1 / 2, //2
    2, 86, 0, 79, 90, BT1 / 2, //5
    2, 79, 0, 77, 90, BT1 / 2, //4
    2, 77, 0, 84, 90, BT1 / 2, //1
    2, 84, 0, 83, 90, BT1 / 2, //7
    2, 83, 0, 76, 90, BT1 / 2, //3
    2, 76, 0, 79, 90, BT1 / 2, //5
    2, 79, 0, 86, 90, BT1 / 2, //2

    3, 0xFF, 58, 120, 0xFF, 86, 0, 91, 90, BT1 * 4, //5

    //第一小节
    //C和弦
    2, 91, 0, 48, 70, BT1 / 2,
    1, 55, 70, BT1 / 2,
    2, 55, 0, 60, 70, BT1 / 2,
    2, 60, 0, 64, 70, BT1 / 2,
    //C和弦
    1, 64, 70, BT1 / 2,
    1, 55, 70, BT1 / 2,
    4, 48, 0, 55, 0,  60, 70, 55, 100, BT1 / 2, //5
    4, 60, 0, 55, 0,  64, 70, 57, 100, BT1 / 2, //6

    //第二小节
    //C和弦
    4, 64, 0, 57, 0, 48, 101, 60, 100, BT1 / 2, //1
    3, 60, 0, 55, 70,  60, 100, BT1 / 2, //1
    4, 55, 0, 60, 0,   60, 70,  60, 100, BT1 / 2, //1
    5, 48, 0, 60, 0,   60, 0, 64, 70, 62, 100, BT1 / 4, //2
    2, 62, 0, 64, 100, BT1 / 4, //3
    //Em和弦
    1 + 1, 0xFF, 74, 90, 0xFF, 40, 101, BT1 / 2, //
    1 + 1, 0xFF, 64, 90, 0xFF, 55, 70, BT1 / 2,
    2 + 1, 0xFF, 63, 90, 0xFF, 55, 0, 59, 70, BT1 / 2, //0
    4 + 1, 0xFF, 64, 90, 0xFF, 40, 0, 59, 0, 64, 70,  64, 100, BT1 / 4, //3
    1, 67, 100, BT1 / 4, //5

    //第三小节
    //Am和弦
    4, 64, 0, 67, 0,  45, 101, 69, 100, BT1 / 2, //6
    2, 57, 70, 69, 100, BT1 / 2, //6
    4, 57, 0, 69, 0, 60, 70, 71, 100, BT1 / 3, //7
    2, 71, 0, 69, 100, BT1 / 6, //6
    3, 45, 0, 60, 0, 64, 70, BT1 / 6,
    2, 69, 0, 67, 100, BT1 / 3, //5
    //Em和弦
    4 + 1, 0xFF, 74, 90, 0xFF, 64, 0, 67, 0, 40, 101, 64, 100, BT1 / 2, //3
    1, 55, 70, BT1 / 2,
    3, 55, 0, 64, 0, 59, 70, BT1 / 2, //0
    4, 40, 0, 59, 0, 64, 70, 64, 100, BT1 / 2, //3

    //第四小节
    //Dm和弦
    3, 64, 0,  50, 101, 62, 100, BT1 / 2, //2
    1, 57, 70, BT1 / 2,
    4, 57, 0,  62, 0, 62, 70, 62, 100, BT1 / 4, //2
    1, 60, 100, BT1 / 4, //1
    5, 62, 0, 60, 0, 50, 0, 65, 70, 57, 100, BT1 / 4, //6
    2, 57, 0, 55, 100, BT1 / 4, //5
    //Am和弦
    4 + 1, 0xFF, 74, 90, 0xFF, 65, 0, 55, 0, 45, 101, 57, 100, BT1 / 2, //6
    1 + 1, 0xFF, 64, 90, 0xFF, 57, 70, BT1 / 2,
    2 + 1, 0xFF, 63, 90, 0xFF, 57, 0, 60, 70, BT1 / 2,
    3 + 1, 0xFF, 64, 90, 0xFF, 45, 0, 60, 0, 64, 70, BT1 / 4, //0
    1, 55, 100, BT1 / 4, //5

    //第五小节
    //F和弦
    4, 64, 0, 55, 0, 41, 101, 60, 100, BT1 / 2, //1
    1, 57, 70, BT1 / 2,
    3, 57, 0, 60, 70,  60, 100, BT1 / 2, //1
    4, 41, 0, 60, 0, 64, 70, 60, 100, BT1 / 2, //1
    //G和弦
    4 + 1, 0xFF, 74, 90, 0xFF, 64, 0, 60, 0, 43, 101, 62, 100, BT1 / 2, //2
    1, 55, 70, BT1 / 2,
    2, 55, 0, 59, 70, BT1 / 2, //0
    4, 59, 0, 43, 0, 67, 70, 55, 100, BT1 / 4, //5
    2, 55, 0, 57, 100, BT1 / 4, //6

    //第六小节
    //C和弦
    4, 67, 0, 57, 0, 48, 101, 60, 100, BT1 / 2, //1
    3, 60, 0, 55, 70,  60, 100, BT1 / 2, //1
    4, 55, 0, 60, 0,   60, 70,  60, 100, BT1 / 2, //1
    5, 48, 0, 60, 0,   60, 0, 64, 70, 62, 100, BT1 / 4, //2
    2, 62, 0, 64, 100, BT1 / 4, //3
    //Em和弦
    1 + 1, 0xFF, 74, 90, 0xFF, 40, 101, BT1 / 2, //
    1 + 1, 0xFF, 64, 90, 0xFF, 55, 70, BT1 / 2,
    2 + 1, 0xFF, 63, 90, 0xFF, 55, 0, 59, 70, BT1 / 2, //0
    4 + 1, 0xFF, 64, 90, 0xFF, 40, 0, 59, 0, 64, 70,  64, 100, BT1 / 4, //3
    1, 67, 100, BT1 / 4, //5

    //第七小节
    //Am和弦
    4, 64, 0, 67, 0,  45, 101, 69, 100, BT1 / 2, //6
    2, 57, 70, 69, 100, BT1 / 2, //6
    4, 57, 0, 69, 0, 60, 70, 71, 100, BT1 / 3, //7
    2, 71, 0, 69, 100, BT1 / 6, //6
    3, 45, 0, 60, 0, 64, 70, BT1 / 6,
    2, 69, 0, 67, 100, BT1 / 3, //5
    //Em和弦
    4 + 1, 0xFF, 74, 90, 0xFF, 64, 0, 67, 0, 40, 101, 64, 100, BT1 / 2, //3
    1, 55, 70, BT1 / 2,
    3, 55, 0, 64, 0, 59, 70, BT1 / 2, //0
    4, 40, 0, 59, 0, 64, 70, 64, 100, BT1 / 2, //3

    //第八小节
    //Dm和弦
    3, 64, 0,  50, 101, 62, 100, BT1 / 2, //2
    1, 57, 70, BT1 / 2,
    4, 57, 0,  62, 0, 62, 70, 62, 100, BT1 / 4, //2
    1, 60, 100, BT1 / 4, //1
    5, 62, 0, 60, 0, 50, 0, 65, 70, 57, 100, BT1 / 4, //6
    2, 57, 0, 55, 100, BT1 / 4, //5
    //Am和弦
    4 + 1, 0xFF, 74, 90, 0xFF, 65, 0, 55, 0, 45, 101, 57, 100, BT1 / 2, //6
    1 + 1, 0xFF, 64, 90, 0xFF, 57, 70, BT1 / 2,
    2 + 1, 0xFF, 63, 90, 0xFF, 57, 0, 60, 70, BT1 / 2,
    3 + 1, 0xFF, 64, 90, 0xFF, 45, 0, 60, 100, 64, 70, BT1 / 2, //1

    //第九小节
    //Em和弦
    4, 60, 0, 64, 0, 40, 101, 59, 100, BT1 / 2, //7
    1, 55, 70, BT1 / 2,
    4, 55, 0, 59, 0, 59, 70, 57, 100, BT1 / 2, //6
    5, 40, 0, 59, 0, 57, 0, 64, 70, 55, 100, BT1 / 2, //5
    //Am和弦
    4 + 1, 0xFF, 74, 90, 0xFF, 64, 0, 55, 0, 45, 101, 57, 100, BT1 / 2, //6
    1 + 1, 0xFF, 64, 90, 0xFF, 57, 70, BT1 / 2,
    3 + 1, 0xFF, 63, 90, 0xFF, 57, 0, 60, 70, 60, 100, BT1 / 2, //1
    4 + 1, 0xFF, 64, 90, 0xFF, 60, 0, 45, 0,  64, 70, 62, 100, BT1 / 2, //2

    //第十小节
    //C和弦
    4 + 2, 0xFF, 35, 90, 42, 90, 0xFF, 64, 0, 62, 0, 48, 101, 64, 100, BT1 / 2, //3
    3 + 1, 0xFF, 75, 90, 0xFF, 64, 0, 55, 70, 67, 100, BT1 / 2, //5
    4 + 2, 0xFF, 37, 90, 42, 90, 0xFF, 55, 0, 67, 0, 60, 70, 64, 100, BT1 / 4, //3
    2, 64, 0, 62, 100, BT1 / 4, //2
    5, 48, 0, 60, 0, 62, 0, 64, 70, 60, 100, BT1 / 4, //1
    2, 60, 0, 62, 100, BT1 / 4, //2
    //Am和弦
    4 + 2, 0xFF, 35, 90, 42, 90, 0xFF, 64, 0, 62, 0, 45, 101, 64, 100, BT1 / 2, //3
    3 + 1, 0xFF, 35, 90, 0xFF, 64, 0, 57, 70, 69, 100, BT1 / 2, //6
    4 + 2, 0xFF, 37, 90, 42, 90, 0xFF, 57, 0, 69, 0, 60, 70, 64, 100, BT1 / 4, //3
    2, 64, 0, 62, 100, BT1 / 4, //2
    5, 45, 0, 60, 0, 62, 0, 64, 70, 60, 100, BT1 / 4, //1
    2, 60, 0, 62, 100, BT1 / 4, //2

    //第十一小节
    //Em和弦
    4 + 2, 0xFF, 35, 90, 42, 90, 0xFF, 62, 0, 64, 0, 40, 101, 64, 100, BT1 / 2, //3
    3 + 1, 0xFF, 75, 90, 0xFF, 64, 0, 55, 70, 71, 100, BT1 / 2, //7
    4 + 2, 0xFF, 37, 90, 42, 90, 0xFF, 55, 0, 71, 0,  59, 70,  71, 100, BT1 / 2, //7
    5, 40, 0, 59, 0, 71, 0, 64, 70, 67, 100, BT1 / 2, //5
    //Am和弦
    4 + 2, 0xFF, 35, 90, 42, 90, 0xFF, 64, 0, 67, 0, 45, 101, 69, 100, BT1 / 2, //6
    1 + 1, 0xFF, 35, 90, 0xFF, 57, 70, BT1 / 2,
    3 + 2, 0xFF, 37, 90, 42, 90, 0xFF, 57, 0, 60, 70, 69, 100, BT1 / 2, //6
    5, 45, 0, 60, 0, 69, 0, 64, 70, 67, 100, BT1 / 2, //5

    //第十二小节
    //F和弦
    4 + 2, 0xFF, 35, 90, 42, 90, 0xFF, 64, 0, 69, 0, 41, 101, 69, 100, BT1 / 2, //6
    3 + 1, 0xFF, 75, 90, 0xFF, 69, 0, 57, 70, 67, 100, BT1 / 2, //5
    4 + 2, 0xFF, 37, 90, 42, 90, 0xFF, 57, 0, 67, 0, 60, 70, 69, 100, BT1 / 4, //6
    2, 69, 0, 67, 100, BT1 / 4, //5
    5, 41, 0, 60, 0, 67, 0, 65, 70, 64, 100, BT1 / 4, //3
    2, 64, 0, 62, 100, BT1 / 4, //2
    //C和弦
    4 + 2, 0xFF, 35, 90, 42, 90, 0xFF, 65, 0, 62, 0, 48, 101, 64, 100, BT1 / 2, //3
    3 + 1, 0xFF, 35, 90, 0xFF, 64, 0, 55, 70, 67, 100, BT1 / 2, //5
    4 + 2, 0xFF, 37, 90, 42, 90, 0xFF, 55, 0, 67, 0, 60, 70, 64, 100, BT1 / 2, //3
    5, 48, 0, 60, 0, 64, 0, 64, 70, 64, 100, BT1 / 2, //3

    //第十三小节
    //Dm和弦
    3 + 2, 0xFF, 35, 90, 42, 90, 0xFF, 64, 0, 50, 101, 62, 100, BT1 / 2, //2
    1 + 1, 0xFF, 75, 90, 0xFF, 57, 70, BT1 / 2,
    3 + 2, 0xFF, 37, 90, 42, 90, 0xFF, 57, 0, 62, 70, 60, 100, BT1 / 2, //1
    5, 50, 0, 62, 0, 60, 0, 65, 70, 62, 100, BT1 / 2, //2
    //Em和弦
    4 + 2, 0xFF, 35, 90, 42, 90, 0xFF, 65, 0, 62, 0, 40, 101, 64, 100, BT1 / 2, //3
    1 + 1, 0xFF, 35, 90, 0xFF, 55, 70, BT1 / 2,
    3 + 2, 0xFF, 37, 90, 42, 90, 0xFF, 55, 0, 59, 70, 60, 100, BT1 / 2, //1
    5, 40, 0, 59, 0, 60, 0, 64, 70, 62, 100, BT1 / 2, //2

    //第十四小节
    //C和弦
    4 + 2, 0xFF, 35, 90, 42, 90, 0xFF, 64, 0, 62, 0, 48, 101, 64, 100, BT1 / 2, //3
    3 + 1, 0xFF, 75, 90, 0xFF, 64, 0, 55, 70, 67, 100, BT1 / 2, //5
    4 + 2, 0xFF, 37, 90, 42, 90, 0xFF, 55, 0, 67, 0, 60, 70, 64, 100, BT1 / 4, //3
    2, 64, 0, 62, 100, BT1 / 4, //2
    5, 48, 0, 60, 0, 62, 0, 64, 70, 60, 100, BT1 / 4, //1
    2, 60, 0, 62, 100, BT1 / 4, //2
    //Am和弦
    4 + 2, 0xFF, 35, 90, 42, 90, 0xFF, 64, 0, 62, 0, 45, 101, 64, 100, BT1 / 2, //3
    3 + 1, 0xFF, 35, 90, 0xFF, 64, 0, 57, 70, 69, 100, BT1 / 2, //6
    4 + 2, 0xFF, 37, 90, 42, 90, 0xFF, 57, 0, 69, 0, 60, 70, 64, 100, BT1 / 4, //3
    2, 64, 0, 62, 100, BT1 / 4, //2
    5, 45, 0, 60, 0, 62, 0, 64, 70, 60, 100, BT1 / 4, //1
    2, 60, 0, 62, 100, BT1 / 4, //2

    //第十五小节
    //Em和弦
    4 + 2, 0xFF, 35, 90, 42, 90, 0xFF, 62, 0, 64, 0, 40, 101, 64, 100, BT1 / 2, //3
    3 + 1, 0xFF, 75, 90, 0xFF, 64, 0, 55, 70, 71, 100, BT1 / 2, //7
    4 + 2, 0xFF, 37, 90, 42, 90, 0xFF, 55, 0, 71, 0,  59, 70,  71, 100, BT1 / 2, //7
    5, 40, 0, 59, 0, 71, 0, 64, 70, 67, 100, BT1 / 2, //5
    //Am和弦
    4 + 2, 0xFF, 35, 90, 42, 90, 0xFF, 64, 0, 67, 0, 45, 101, 69, 100, BT1 / 2, //6
    1 + 1, 0xFF, 35, 90, 0xFF, 57, 70, BT1 / 2,
    3 + 2, 0xFF, 37, 90, 42, 90, 0xFF, 57, 0, 60, 70, 69, 100, BT1 / 2, //6
    5, 45, 0, 60, 0, 69, 0, 64, 70, 67, 100, BT1 / 4, //5
    2, 67, 0, 69, 100, BT1 / 4, //6

    //第十六小节
    //D和弦
    4 + 2, 0xFF, 35, 90, 42, 90, 0xFF, 64, 0, 59, 0, 50, 101, 69, 100, BT1 / 2, //6
    1 + 1, 0xFF, 75, 90, 0xFF, 57, 70, BT1 / 2,
    2 + 2, 0xFF, 37, 90, 42, 90, 0xFF, 57, 0, 62, 70, BT1 / 2,
    5, 50, 0, 62, 0, 69, 0, 66, 70, 67, 100, BT1 / 2, //5
    //D和弦
    4 + 2, 0xFF, 35, 90, 42, 90, 0xFF, 66, 0, 67, 0, 50, 101, 69, 100, BT1 / 2, //6
    3 + 1, 0xFF, 35, 90, 0xFF, 69, 0, 57, 70, 72, 100, BT1 / 2, //1
    2 + 2, 0xFF, 37, 90, 42, 90, 0xFF, 57, 0, 62, 70, BT1 / 2,
    5, 50, 0, 62, 0, 72, 0, 66, 70, 69, 100, BT1 / 2, //6

    //第十七小节
    //G和弦
    4 + 1, 0xFF, 35, 90, 0xFF, 66, 0, 69, 0, 43, 101, 64, 100, BT1 / 2, //3
    3 + 2, 0xFF, 35, 90, 42, 90, 0xFF, 64, 0, 55, 70, 67, 100, BT1 / 2, //5
    2 + 1, 0xFF, 45, 90, 0xFF, 55, 0, 59, 70, BT1 / 2,
    3 + 2, 0xFF, 43, 90, 46, 90, 0xFF, 43, 0, 59, 0, 67, 70, BT1 / 2,
    //G和弦
    1 + 1, 0xFF, 42, 90, 0xFF, 43, 60, BT1 / 2,
    1 + 1, 0xFF, 46, 90, 0xFF, 55, 50, BT1 / 2,
    3 + 1, 0xFF, 42, 90, 0xFF, 55, 0, 67, 0, 59, 50, BT1 / 4,
    1, 0xFF, 46, 90, BT1 / 4,
    4 + 1, 42, 90, 0xFF, 43, 0, 59, 0, 67, 60, 55, 100, BT1 / 4, //5
    2 + 2, 0xFF, 42, 90, 46, 90, 0xFF, 55, 0, 57, 100, BT1 / 4, //6

    //第十八小节
    //C和弦
    4 + 2, 0xFF, 35, 90, 42, 90, 0xFF, 67, 0, 57, 0, 48, 101, 60, 100, BT1 / 2, //1
    3 + 1, 0xFF, 42, 90, 0xFF, 60, 0, 55, 70,  60, 100, BT1 / 2, //1
    4 + 2, 0xFF, 38, 90, 46, 90, 0xFF, 55, 0, 60, 0,   60, 70,  60, 100, BT1 / 2, //1
    5 + 1, 0xFF, 42, 90, 0xFF, 48, 0, 60, 0,   60, 0, 64, 70, 62, 100, BT1 / 4, //2
    2, 62, 0, 64, 100, BT1 / 4, //3
    //Em和弦
    1 + 2, 0xFF, 35, 90, 42, 90, 0xFF, 40, 101, BT1 / 2, //
    1 + 2, 0xFF, 35, 90, 42, 90, 0xFF, 55, 70, BT1 / 2,
    2 + 2, 0xFF, 38, 90, 46, 90, 0xFF, 55, 0, 59, 70, BT1 / 2, //0
    4 + 2, 0xFF, 35, 90, 42, 90, 0xFF, 40, 0, 59, 0, 64, 70,  64, 100, BT1 / 4, //3
    1, 67, 100, BT1 / 4, //5

    //第十九小节
    //Am和弦
    4 + 2, 0xFF, 35, 90, 42, 90, 0xFF, 64, 0, 67, 0,  45, 101, 69, 100, BT1 / 2, //6
    2 + 1, 0xFF, 42, 90, 0xFF, 57, 70, 69, 100, BT1 / 2, //6
    4 + 2, 0xFF, 38, 90, 46, 90, 0xFF, 57, 0, 69, 0, 60, 70, 71, 100, BT1 / 3, //7
    2, 71, 0, 69, 100, BT1 / 6, //6
    3 + 1, 0xFF, 42, 90, 0xFF, 45, 0, 60, 0, 64, 70, BT1 / 6,
    2, 69, 0, 67, 100, BT1 / 3, //5
    //Em和弦
    4 + 2, 0xFF, 35, 90, 42, 90, 0xFF, 64, 0, 67, 0, 40, 101, 64, 100, BT1 / 2, //3
    1 + 2, 0xFF, 35, 90, 42, 90, 0xFF, 55, 70, BT1 / 2,
    3 + 2, 0xFF, 38, 90, 46, 90, 0xFF, 55, 0, 64, 0, 59, 70, BT1 / 2, //0
    4 + 2, 0xFF, 35, 90, 42, 90, 0xFF, 40, 0, 59, 0, 64, 70, 64, 100, BT1 / 2, //3

    //第二十小节
    //Dm和弦
    3 + 2, 0xFF, 35, 90, 42, 90, 0xFF, 64, 0,  50, 101, 62, 100, BT1 / 2, //2
    1 + 1, 0xFF, 42, 90, 0xFF, 57, 70, BT1 / 2,
    4 + 2, 0xFF, 38, 90, 46, 90, 0xFF, 57, 0,  62, 0, 62, 70, 62, 100, BT1 / 4, //2
    1, 60, 100, BT1 / 4, //1
    5 + 1, 0xFF, 42, 90, 0xFF, 62, 0, 60, 0, 50, 0, 65, 70, 57, 100, BT1 / 4, //6
    2, 57, 0, 55, 100, BT1 / 4, //5
    //Am和弦
    4 + 2, 0xFF, 35, 90, 42, 90, 0xFF, 65, 0, 55, 0, 45, 101, 57, 100, BT1 / 2, //6
    1 + 2, 0xFF, 35, 90, 42, 90, 0xFF, 57, 70, BT1 / 2,
    2 + 2, 0xFF, 38, 90, 46, 90, 0xFF, 57, 0, 60, 70, BT1 / 2,
    3 + 2, 0xFF, 35, 90, 42, 90, 0xFF, 45, 0, 60, 100, 64, 70, BT1 / 2, //1

    //第二十一小节
    //Em和弦
    4 + 2, 0xFF, 35, 90, 42, 90, 0xFF, 60, 0, 64, 0, 40, 101, 59, 100, BT1 / 2, //7
    1 + 1, 0xFF, 42, 90, 0xFF, 55, 70, BT1 / 2,
    4 + 2, 0xFF, 38, 90, 46, 90, 0xFF, 55, 0, 59, 0, 59, 70, 57, 100, BT1 / 2, //6
    5 + 1, 0xFF, 42, 90, 0xFF, 40, 0, 59, 0, 57, 0, 64, 70, 55, 100, BT1 / 2, //5
    //Am和弦
    4 + 2, 0xFF, 35, 90, 42, 90, 0xFF, 64, 0, 55, 0, 45, 101, 57, 100, BT1 / 2, //6
    1 + 2, 0xFF, 35, 90, 42, 90, 0xFF, 57, 70, BT1 / 2,
    3 + 2, 0xFF, 46, 90, 47, 90, 0xFF, 57, 0, 60, 70, 60, 100, BT1 / 4, //1
    1,   0xFF, 47, 90, BT1 / 4,
    4 + 2, 42, 90, 43, 90, 0xFF, 60, 0, 45, 0,  64, 70, 62, 100, BT1 / 2, //2

    //第二十二小节
    //C和弦
    4 + 4, 0xFF, 38, 90, 57, 90, 35, 90, 42, 90, 0xFF, 64, 0, 62, 0, 48, 101, 64, 100, BT1 / 2, //3
    3 + 1, 0xFF, 42, 90, 0xFF, 64, 0, 55, 70, 67, 100, BT1 / 2, //5
    4 + 2, 0xFF, 38, 90, 46, 90, 0xFF, 55, 0, 67, 0, 60, 70, 64, 100, BT1 / 4, //3
    2, 64, 0, 62, 100, BT1 / 4, //2
    5 + 1, 0xFF, 42, 90, 0xFF, 48, 0, 60, 0, 62, 0, 64, 70, 60, 100, BT1 / 4, //1
    2, 60, 0, 62, 100, BT1 / 4, //2
    //Am和弦
    4 + 2, 0xFF, 35, 90, 42, 90, 0xFF, 64, 0, 62, 0, 45, 101, 64, 100, BT1 / 2, //3
    3 + 2, 0xFF, 35, 90, 42, 90, 0xFF, 64, 0, 57, 70, 69, 100, BT1 / 2, //6
    4 + 2, 0xFF, 38, 90, 46, 90, 0xFF, 57, 0, 69, 0, 60, 70, 64, 100, BT1 / 4, //3
    2, 64, 0, 62, 100, BT1 / 4, //2
    5 + 2, 0xFF, 35, 90, 42, 90, 0xFF, 45, 0, 60, 0, 62, 0, 64, 70, 60, 100, BT1 / 4, //1
    2, 60, 0, 62, 100, BT1 / 4, //2

    //第二十三小节
    //Em和弦
    4 + 2, 0xFF, 35, 90, 42, 90, 0xFF, 62, 0, 64, 0, 40, 101, 64, 100, BT1 / 2, //3
    3 + 1, 0xFF, 42, 90, 0xFF, 64, 0, 55, 70, 71, 100, BT1 / 2, //7
    4 + 2, 0xFF, 38, 90, 46, 90, 0xFF, 55, 0, 71, 0,  59, 70,  71, 100, BT1 / 2, //7
    5 + 1, 0xFF, 42, 90, 0xFF, 40, 0, 59, 0, 71, 0, 64, 70, 67, 100, BT1 / 2, //5
    //Am和弦
    4 + 2, 0xFF, 35, 90, 42, 90, 0xFF, 64, 0, 67, 0, 45, 101, 69, 100, BT1 / 2, //6
    1 + 2, 0xFF, 35, 90, 42, 90, 0xFF, 57, 70, BT1 / 2,
    3 + 2, 0xFF, 38, 90, 46, 90, 0xFF, 57, 0, 60, 70, 69, 100, BT1 / 2, //6
    5 + 2, 0xFF, 35, 90, 42, 90, 0xFF, 45, 0, 60, 0, 69, 0, 64, 70, 67, 100, BT1 / 2, //5

    //第二十四小节
    //F和弦
    4 + 2, 0xFF, 35, 90, 42, 90, 0xFF, 64, 0, 69, 0, 41, 101, 69, 100, BT1 / 2, //6
    3 + 1, 0xFF, 42, 90, 0xFF, 69, 0, 57, 70, 67, 100, BT1 / 2, //5
    4 + 2, 0xFF, 38, 90, 46, 90, 0xFF, 57, 0, 67, 0, 60, 70, 69, 100, BT1 / 4, //6
    2, 69, 0, 67, 100, BT1 / 4, //5
    5 + 1, 0xFF, 42, 90, 0xFF, 41, 0, 60, 0, 67, 0, 65, 70, 64, 100, BT1 / 4, //3
    2, 64, 0, 62, 100, BT1 / 4, //2
    //C和弦
    4 + 2, 0xFF, 35, 90, 42, 90, 0xFF, 65, 0, 62, 0, 48, 101, 64, 100, BT1 / 2, //3
    3 + 2, 0xFF, 35, 90, 42, 90, 0xFF, 64, 0, 55, 70, 67, 100, BT1 / 2, //5
    4 + 2, 0xFF, 38, 90, 46, 90, 0xFF, 55, 0, 67, 0, 60, 70, 64, 100, BT1 / 2, //3
    5 + 2, 0xFF, 35, 90, 42, 90, 0xFF, 48, 0, 60, 0, 64, 0, 64, 70, 64, 100, BT1 / 2, //3

    //第二十五小节
    //Dm和弦
    3 + 2, 0xFF, 35, 90, 42, 90, 0xFF, 64, 0, 50, 101, 62, 100, BT1 / 2, //2
    1 + 1, 0xFF, 42, 90, 0xFF, 57, 70, BT1 / 2,
    3 + 2, 0xFF, 38, 90, 46, 90, 0xFF, 57, 0, 62, 70, 60, 100, BT1 / 2, //1
    5 + 1, 0xFF, 42, 90, 0xFF, 50, 0, 62, 0, 60, 0, 65, 70, 62, 100, BT1 / 2, //2
    //Em和弦
    4 + 2, 0xFF, 35, 90, 42, 90, 0xFF, 65, 0, 62, 0, 40, 101, 64, 100, BT1 / 2, //3
    1 + 2, 0xFF, 35, 90, 42, 90, 0xFF, 55, 70, BT1 / 2,
    3 + 2, 0xFF, 46, 90, 47, 90, 0xFF, 55, 0, 59, 70, 60, 100, BT1 / 4, //1
    1,   0xFF, 47, 90, BT1 / 4,
    5 + 2, 42, 90, 43, 90, 0xFF, 40, 0, 59, 0, 60, 0, 64, 70, 62, 100, BT1 / 2, //2

    //第二十六小节
    //C和弦
    4 + 4, 0xFF, 38, 90, 57, 90, 35, 90, 42, 90, 0xFF, 64, 0, 62, 0, 48, 101, 64, 100, BT1 / 2, //3
    3 + 1, 0xFF, 42, 90, 0xFF, 64, 0, 55, 70, 67, 100, BT1 / 2, //5
    4 + 2, 0xFF, 38, 90, 46, 90, 0xFF, 55, 0, 67, 0, 60, 70, 64, 100, BT1 / 4, //3
    2, 64, 0, 62, 100, BT1 / 4, //2
    5 + 1, 0xFF, 42, 90, 0xFF, 48, 0, 60, 0, 62, 0, 64, 70, 60, 100, BT1 / 4, //1
    2, 60, 0, 62, 100, BT1 / 4, //2
    //Am和弦
    4 + 2, 0xFF, 35, 90, 42, 90, 0xFF, 64, 0, 62, 0, 45, 101, 64, 100, BT1 / 2, //3
    3 + 2, 0xFF, 35, 90, 42, 90, 0xFF, 64, 0, 57, 70, 69, 100, BT1 / 2, //6
    4 + 2, 0xFF, 38, 90, 46, 90, 0xFF, 57, 0, 69, 0, 60, 70, 64, 100, BT1 / 4, //3
    2, 64, 0, 62, 100, BT1 / 4, //2
    5 + 2, 0xFF, 35, 90, 42, 90, 0xFF, 45, 0, 60, 0, 62, 0, 64, 70, 60, 100, BT1 / 4, //1
    2, 60, 0, 62, 100, BT1 / 4, //2

    //第二十七小节
    //Em和弦
    4 + 2, 0xFF, 35, 90, 42, 90, 0xFF, 62, 0, 64, 0, 40, 101, 64, 100, BT1 / 2, //3
    3 + 1, 0xFF, 42, 90, 0xFF, 64, 0, 55, 70, 71, 100, BT1 / 2, //7
    4 + 2, 0xFF, 38, 90, 46, 90, 0xFF, 55, 0, 71, 0,  59, 70,  71, 100, BT1 / 2, //7
    5 + 1, 0xFF, 42, 90, 0xFF, 40, 0, 59, 0, 71, 0, 64, 70, 67, 100, BT1 / 2, //5
    //Am和弦
    4 + 2, 0xFF, 35, 90, 42, 90, 0xFF, 64, 0, 67, 0, 45, 101, 69, 100, BT1 / 2, //6
    1 + 2, 0xFF, 35, 90, 42, 90, 0xFF, 57, 70, BT1 / 2,
    3 + 2, 0xFF, 38, 90, 46, 90, 0xFF, 57, 0, 60, 70, 69, 100, BT1 / 2, //6
    5 + 2, 0xFF, 35, 90, 42, 90, 0xFF, 45, 0, 60, 0, 69, 0, 64, 70, 67, 100, BT1 / 4, //5
    2, 67, 0, 69, 100, BT1 / 4, //6

    //第二十八小节
    //D和弦
    4 + 2, 0xFF, 35, 90, 42, 90, 0xFF, 64, 0, 59, 0, 50, 101, 69, 100, BT1 / 2, //6
    1 + 1, 0xFF, 42, 90, 0xFF, 57, 70, BT1 / 2,
    2 + 2, 0xFF, 38, 90, 46, 90, 0xFF, 57, 0, 62, 70, BT1 / 2,
    5 + 1, 0xFF, 42, 90, 0xFF, 50, 0, 62, 0, 69, 0, 66, 70, 67, 100, BT1 / 2, //5
    //D和弦
    4 + 2, 0xFF, 35, 90, 42, 90, 0xFF, 66, 0, 67, 0, 50, 101, 69, 100, BT1 / 2, //6
    3 + 2, 0xFF, 35, 90, 42, 90, 0xFF, 69, 0, 57, 70, 72, 100, BT1 / 2, //1
    2 + 2, 0xFF, 38, 90, 46, 90, 0xFF, 57, 0, 62, 70, BT1 / 2,
    5 + 2, 0xFF, 35, 90, 42, 90, 0xFF, 50, 0, 62, 0, 72, 0, 66, 70, 69, 100, BT1 / 2, //6

    //第二十九小节
    //G和弦
    4 + 4, 0xFF, 38, 90, 35, 90, 42, 90, 57, 90, 0xFF, 66, 0, 69, 0, 43, 101, 64, 100, BT1 / 2, //3
    3 + 1, 0xFF, 42, 90, 0xFF, 64, 0, 55, 70, 67, 100, BT1 / 4, //5
    1,   0xFF, 35, 90, BT1 / 4,
    2 + 2, 42, 90, 47, 90, 0xFF, 55, 0, 59, 70, BT1 / 2,
    3 + 3, 0xFF, 46, 90, 42, 90, 57, 90, 0xFF, 43, 0, 59, 0, 67, 70, BT1 / 2,
    //G和弦
    1, 43, 60, BT1 / 2,
    1, 55, 50, BT1 / 2,
    3, 55, 0, 67, 0, 59, 50, BT1 / 2,
    4, 43, 0, 59, 0, 67, 60, 55, 100, BT1 / 4, //5
    2, 55, 0, 57, 100, BT1 / 4, //6

    //第三十小节
    //C和弦
    4, 67, 0, 57, 0, 48, 101, 60, 100, BT1 / 2, //1
    3, 60, 0, 55, 70,  60, 100, BT1 / 2, //1
    4, 55, 0, 60, 0,   60, 70,  60, 100, BT1 / 2, //1
    5, 48, 0, 60, 0,   60, 0, 64, 70, 62, 100, BT1 / 4, //2
    2, 62, 0, 64, 100, BT1 / 4, //3
    //Em和弦
    1, 40, 101, BT1 / 2, //
    1, 55, 70, BT1 / 2,
    2, 55, 0, 59, 70, BT1 / 2, //0
    4, 40, 0, 59, 0, 64, 70,  64, 100, BT1 / 4, //3
    1, 67, 100, BT1 / 4, //5

    //第三十一小节
    //Am和弦
    4, 64, 0, 67, 0,  45, 101, 69, 100, BT1 / 2, //6
    2, 57, 70, 69, 100, BT1 / 2, //6
    4, 57, 0, 69, 0, 60, 70, 71, 100, BT1 / 3, //7
    2, 71, 0, 69, 100, BT1 / 6, //6
    3, 45, 0, 60, 0, 64, 70, BT1 / 6,
    2, 69, 0, 67, 100, BT1 / 3, //5
    //Em和弦
    4, 64, 0, 67, 0, 40, 101, 64, 100, BT1 / 2, //3
    1, 55, 70, BT1 / 2,
    3, 55, 0, 64, 0, 59, 70, BT1 / 2, //0
    4, 40, 0, 59, 0, 64, 70, 64, 100, BT1 / 2, //3

    //第三十二小节
    //Dm和弦
    3, 64, 0,  50, 101, 62, 100, BT1 / 2, //2
    1, 57, 70, BT1 / 2,
    4, 57, 0,  62, 0, 62, 70, 62, 100, BT1 / 4, //2
    1, 60, 100, BT1 / 4, //1
    5, 62, 0, 60, 0, 50, 0, 65, 70, 57, 100, BT1 / 4, //6
    2, 57, 0, 55, 100, BT1 / 4, //5
    //Am和弦
    4, 65, 0, 55, 0, 45, 101, 57, 100, BT1 / 2, //6
    1, 57, 70, BT1 / 2,
    2, 57, 0, 60, 70, BT1 / 2,
    3, 45, 0, 60, 100, 64, 70, BT1 / 2, //1

    //第三十三小节
    //Em和弦
    4, 60, 0, 64, 0, 40, 101, 59, 100, BT1 / 2, //7
    1, 55, 70, BT1 / 2,
    4, 55, 0, 59, 0, 59, 70, 57, 100, BT1 / 2, //6
    5, 40, 0, 59, 0, 57, 0, 64, 70, 55, 100, BT1 / 2, //5
    //Am和弦
    4, 64, 0, 55, 0, 45, 101, 57, 100, BT1 / 2, //6
    1, 57, 70, BT1 / 2,
    2, 57, 0, 60, 70, BT1 / 2,
    4, 60, 0, 45, 0, 64, 70, 57, 0, BT1 / 2,

    //第三十四小节
    //Dm和弦
    3, 64, 0,  50, 101, 62, 100, BT1 / 2, //2
    1, 57, 70, BT1 / 2,
    4, 57, 0,  62, 0, 62, 70, 62, 100, BT1 / 4, //2
    1, 60, 100, BT1 / 4, //1
    5, 62, 0, 60, 0, 50, 0, 65, 70, 57, 100, BT1 / 4, //6
    2, 57, 0, 55, 100, BT1 / 4, //5
    //Am和弦
    4, 65, 0, 55, 0, 45, 101, 57, 100, BT1 / 2, //6
    1, 57, 70, BT1 / 2,
    2, 57, 0, 60, 70, BT1 / 2,
    3, 45, 0, 60, 100, 64, 70, BT1 / 2, //1

    //第三十五小节
    //Em和弦
    4, 60, 0, 64, 0, 40, 101, 59, 100, BT1 / 2, //7
    1, 55, 70, BT1 / 2,
    4, 55, 0, 59, 0, 59, 70, 57, 100, BT1 / 2, //6
    5, 40, 0, 59, 0, 57, 0, 64, 70, 55, 100, BT1 / 2, //5
    //Am和弦
    4, 64, 0, 55, 0, 45, 101, 57, 100, BT1 / 2, //6
    1, 57, 70, BT1 / 2,
    2, 57, 0, 60, 70, BT1 / 2,
    4, 60, 0, 45, 0, 64, 70, 57, 0, BT1 / 2,
    //第三十六小节

    //Dm和弦
    3, 64, 0,  50, 101, 62, 100, BT1 / 2, //2
    1, 57, 70, BT1 / 2,
    4, 57, 0,  62, 0, 62, 70, 62, 100, BT1 / 4, //2
    1, 60, 100, BT1 / 4, //1
    5, 62, 0, 60, 0, 50, 0, 65, 70, 57, 100, BT1 / 4, //6
    2, 57, 0, 55, 100, BT1 / 4, //5
    //Am和弦
    4, 65, 0, 55, 0, 45, 101, 57, 100, BT1 / 2, //6
    1, 57, 70, BT1 / 2,
    2, 57, 0, 60, 70, BT1 / 2,
    //后面不直接用BT1表示，做渐慢处理
    3, 45, 0, 60, 100, 64, 70,  36, 24 / 2, //1

    //第三十七小节
    //Em和弦
    4, 60, 0, 64, 0, 40, 101, 59, 100, 40, 24 / 2, //7
    1, 55, 70,   44, 24 / 2,
    4, 55, 0, 59, 0, 59, 70, 57, 100,  48, 24 / 2, //6
    5, 40, 0, 59, 0, 57, 0, 64, 70, 55, 100, 52, 24 / 2, //5
    //Am和弦
    4, 64, 0, 55, 0, 45, 101, 57, 100, 56, 18, //6

    3, 45, 0, 56, 0, 76 - 12, 70, BT1 / 4,
    1, 69, 70, BT1 / 4,
    1, 72, 70, BT1 / 4,
    1, 88, 70, BT1,
    4, 76, 0, 81, 0, 84, 0, 100, 0, BT1
};


void PlaySong(void)
{
    u32 i, k, t;
    u32 j, n;
    u8 *p;

    u8 Buf[4];

    Buf[0] = 0x09; //Note On的MIDI事件消息包头
    Buf[1] = 0x90; //在通道0上发送Note On消息

    //开始播放前，关掉所有以前的声音
    Buf[3] = 0x00; //力度设置为0

    for (i = 20; i < 128; i++) {
        Buf[2] = i;


        midi_tx_data(NULL, Buf, 4);
    }

    mdelay(500); //等待半秒钟安静了才开始播放

    p = (u8 *)SongTable; //歌曲音符数组

    i = 0;
    //获取歌曲的行数
    k = p[i++];
    k = (k << 8) + p[i++];

    //播放所有行
    while (k--) {
        //获取该行有多少个音符
        n = p[i++];

        //依次发送所有音符
        for (j = 0; j < n; j++) {
            if (p[i] == 0xFF) { //遇到0xFF则切换通道
                if (Buf[1] == 0x90) {
                    Buf[1] = 0x99;    //切换到打击乐通道
                } else {
                    Buf[1] = 0x90;    //切换回旋律乐通道
                }

                i++; //跳过本字节
            }

            //获取某一音符的音高和力度
            Buf[2] = p[i++];
            Buf[3] = p[i++];


            //发送4字节的Note On消息
            midi_tx_data(NULL, Buf, 4);
        }

        //计算实际的时间
        t = p[i++];
        t *= p[i++];
        //延时等待本行播放完毕
        mdelay(t);
        wdt_clear();
    }

    //退出播放时，要关闭所有音符
    Buf[1] = 0x90;
    Buf[3] = 0x00;

    for (i = 20; i < 128; i++) {
        Buf[2] = i;

        midi_tx_data(NULL, Buf, 4);
    }
    log_info("song_play_end\n");
}

/*----------------------------------------------------------------------------*/
/**@brief   demo中向usb发送4byte midi事件的函数示例
   @param   nkey midi音符编号
   @return  无
   @author  mawancheng
   @note    void midi_tx_nkey(u8 nkey)
*/
/*----------------------------------------------------------------------------*/
void midi_tx_nkey(u8 nkey)
{
    u8 Buf[4];

    Buf[0] = 0x09; //时间偏移(00~7f)，仅作用于录制生成的midi文件，当前时间与上一个时间的时间间隔. usb_midi传输不会解析该字节
    Buf[1] = 0x90; //状态字节，该字节通过二进制解析，1001 0000，前4bit(1001)表示note on，后4bit(0000)表示MIDI通道1；0x90就是在通道0上发送Note On消息
    Buf[2] = nkey; //midi音符编号(0-127)
    Buf[3] = 0x64; //力度，范围0~127。力度设置为64就是中等力度

    midi_tx_data(NULL, Buf, 4);
}

//********************************************demo_code_end****************************************//
#endif
